[gd_scene load_steps=6 format=2]

[ext_resource path="res://scripts/WorldGenClient.gd" type="Script" id=1]
[ext_resource path="res://tilesets/Shelves.tres" type="TileSet" id=2]
[ext_resource path="res://tilesets/Kitchen.tres" type="TileSet" id=3]
[ext_resource path="res://scripts/JustMove.gd" type="Script" id=4]

[sub_resource type="GDScript" id=1]
script/source = "extends Node2D

func _ready():
	print(\"  \")
	print(\"level_generate\")
	var config = { \"levelSize\": { \"w\": 30, \"h\": 30 } }
	var level = yield($WorldGenClient.level_generate(config), \"completed\")
	
	#_debug_show_tileset()
	for tile in level.tiles: _process_tile(tile)
	for entity in level.entities: _process_entity(entity)

func _process_entity(entity):
	var p = entity.pos
	match entity.type:
		\"ShelveSmall1\": _shelve(p.x, p.y, 6, 2, 6)
		\"ShelveSmall2\": _shelve(p.x, p.y, 6, 1, 6)
		\"ShelveSmall3\": _shelve(p.x, p.y, 6, 0, 6)
		\"ShelveTall1\": _shelve(p.x, p.y, 2, 0, 0)
		\"ShelveTall2\": _shelve(p.x, p.y, 0, 0, 0)
		\"ShelveTall3\": _shelve(p.x, p.y, 1, 0, 0)
		\"PaperRollScrappy\": _thing(p.x, p.y, 4, 0, 0)
		\"PaperRollBad\": _thing(p.x, p.y, 0, 0, 0)
		\"PaperRollGood\": _thing(p.x, p.y, 1, 0, 0)
		\"PaperRollPrint\": _thing(p.x, p.y, 2, 0, 0)
		\"PaperRollScented\": _thing(p.x, p.y, 3, 0, 0)

func _shelve(x, y, i, cx, cy):
	$Shelves.set_cell(x, y, i, false, false, false, Vector2(cx, cy))

func _thing(x, y, i, cx, cy):
	$Things.set_cell(x, y, i, false, false, false, Vector2(cx, cy))

func _process_tile(tile):
	var idx = [0, 0, 0]
	match tile.type:
		\"FloorTiles1\": idx = [5, 1, 1]
		\"FloorTiles2\": idx = [6, 1, 1]
		\"FloorTiles3\": idx = [7, 1, 1]
		\"FloorStone1\": idx = [4, 1, 1]
		\"FloorStone2\": idx = [9, 1, 1]
		\"Wall1\": idx = [3, 0, 0]
		\"Wall2\": idx = [3, 1, 0]
		\"Wall3\": idx = [3, 2, 0]
		\"Wall4\": idx = [3, 3, 0]
		\"Wall5\": idx = [3, 4, 0]
		\"Wall6\": idx = [3, 5, 0]
		\"Wall7\": idx = [3, 6, 0]
		\"Wall8\": idx = [3, 7, 0]
		\"Wall9\": idx = [3, 8, 0]
		\"DoorHorizontal\": idx = [8, 1, 1]
		\"DoorVertical\": idx = [8, 1, 1]
		_: print(\"unknown tile type \", tile.type)
	$WallFloor.set_cell(tile.pos.x, tile.pos.y, idx[0],
		false, false, false, Vector2(idx[1], idx[2]))

func _debug_show_tileset():
	var tile_set = $WallFloor.tile_set
	for i in tile_set.get_tiles_ids():
		print(tile_set.tile_get_name(i))
		
		if tile_set.tile_get_tile_mode(i) == TileSet.ATLAS_TILE:
			var region = tile_set.tile_get_region(i)
			var size = tile_set.autotile_get_size(i)
			var cx = randi() % int(region.size.x / size.x)
			var cy = randi() % int(region.size.y / size.y)
			var coord = Vector2(cx, cy)
			$WallFloor.set_cell(i, 0, i, false, false, false, coord)
		elif tile_set.tile_get_tile_mode(i) == TileSet.SINGLE_TILE:
			$WallFloor.set_cell(i, 0, i)
	for i in range(10):
		$WallFloor.set_cell(i, 1, 3, false, false, false, Vector2(8,0))
"

[node name="WorldGenTest" type="Node2D"]
script = SubResource( 1 )

[node name="WorldGenClient" type="HTTPRequest" parent="."]
script = ExtResource( 1 )

[node name="WallFloor" type="TileMap" parent="."]
tile_set = ExtResource( 3 )
cell_size = Vector2( 16, 16 )
format = 1

[node name="WallOverlay" type="TileMap" parent="."]
tile_set = ExtResource( 3 )
format = 1

[node name="Shelves" type="TileMap" parent="."]
tile_set = ExtResource( 2 )
cell_size = Vector2( 16, 16 )
format = 1

[node name="Camera2D" type="Camera2D" parent="."]
position = Vector2( 210.693, 141.495 )
current = true
script = ExtResource( 4 )
